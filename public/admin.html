<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 페이지</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>관리자 페이지</h1>
            <input type="text" id="search-input" placeholder="닉네임, 이메일 검색">
<button onclick="searchUsers()">검색</button>

<script>
function searchUsers() {
    const searchQuery = document.getElementById('search-input').value;
    fetch(`/admin/get-users?search=${searchQuery}`)
        .then(response => response.json())
        .then(data => {
            const userList = document.querySelector('#user-list tbody');
            userList.innerHTML = '';

            data.users.forEach(user => {
                const userRow = document.createElement('tr');
                userRow.innerHTML = `
                    <td>${user.nickname}</td>
                    <td>${user.email}</td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>${user.role}</td>
                `;
                userList.appendChild(userRow);
            });
        })
        .catch(err => {
            console.error('검색 실패:', err);
        });
}
</script>

            <nav>
                <ul>
                    <li><a href="index.html">홈</a></li>
                    <li><a href="board.html">게시판</a></li>
                    <li><a href="admin.html">관리자 페이지</a></li>
                    <li><a href="/admin/activity_log.html">활동 로그</a></li>
                    <li><a href="/logout">로그아웃</a></li>
                </ul>
            </nav>
        </div>
        
    </header>
    
    
    
    <main>
        <section class="container">
            <h2>일일 방문자 수</h2>
            <table id="visitor-table">
                <thead>
                    <tr>
                        <th>날짜</th>
                        <th>방문자 수</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 방문자 수 데이터 동적 생성 -->
                </tbody>
            </table>
        </section>

        <section class="container">
            <h2>회원 관리</h2>
            <table id="user-list">
                <thead>
                    <tr>
                        <th>닉네임</th>
                        <th>이메일</th>
                        <th>가입일</th>
                        <th>권한</th>
                        <th>관리</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 회원 목록 동적 생성 -->
                </tbody>
            </table>
        </section>

        <section class="container">
            <h2>게시글 관리</h2>
            <table id="post-list">
                <thead>
                    <tr>
                        <th>제목</th>
                        <th>작성자</th>
                        <th>작성일</th>
                        <th>관리</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 게시글 목록 동적 생성 -->
                </tbody>
            </table>
        </section>
    </main>
        
    <script>
        // 회원 목록 불러오기
        fetch('/admin/get-users')
        .then(response => response.json())
        .then(data => {
            const userList = document.querySelector('#user-list tbody');
            userList.innerHTML = '';

            data.users.forEach(user => {
                const userRow = document.createElement('tr');
                userRow.innerHTML = `
                    <td>${user.nickname}</td>
                    <td>${user.email}</td>
                    <td>${user.role === 'admin' ? '관리자' : '일반 사용자'}</td>  <!-- 권한 표시 -->
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <button onclick="changeRole(${user.id}, '${user.role}')">
                            ${user.role === 'admin' ? '일반 사용자로 변경' : '관리자로 변경'}
                        </button>
                    </td>
                `;
                userList.appendChild(userRow);
            });
        })
        .catch(err => {
            console.error('회원 목록 불러오기 실패:', err);
        });

    // 권한 변경 기능 추가
    function changeRole(userId, currentRole) {
        const newRole = currentRole === 'admin' ? 'user' : 'admin';
        fetch(`/admin/change-role/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ role: newRole })
        })
        .then(response => {
            if (response.ok) {
                alert('권한이 변경되었습니다.');
                location.reload();
            } else {
                alert('권한 변경 실패');
            }
        })
        .catch(err => {
            console.error('권한 변경 오류:', err);
        });
    }
        // 회원 탈퇴
        function deleteUser(userId) {
            if (confirm('해당 회원을 탈퇴 처리하시겠습니까?')) {
                fetch(`/admin/delete-user/${userId}`, {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        alert('회원이 탈퇴 처리되었습니다.');
                        location.reload();
                    } else {
                        alert('회원 탈퇴 실패');
                    }
                })
                .catch(err => {
                    console.error('회원 탈퇴 오류:', err);
                });
            }
        }

        // 게시글 목록 불러오기
        fetch('/admin/get-posts')
            .then(response => response.json())
            .then(data => {
                const postList = document.querySelector('#post-list tbody');
                postList.innerHTML = '';

                data.posts.forEach(post => {
                    const postRow = document.createElement('tr');
                    postRow.innerHTML = `
                        <td>${post.title}</td>
                        <td>${post.author}</td>
                        <td>${new Date(post.created_at).toLocaleDateString()}</td>
                        <td>
                            <button onclick="deletePost(${post.id})">삭제</button>
                        </td>
                    `;
                    postList.appendChild(postRow);
                });
            })
            .catch(err => {
                console.error('게시글 목록 불러오기 실패:', err);
            });

        // 게시글 삭제
        function deletePost(postId) {
            if (confirm('해당 게시글을 삭제하시겠습니까?')) {
                fetch(`/admin/delete-post/${postId}`, {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        alert('게시글이 삭제되었습니다.');
                        location.reload();
                    } else {
                        alert('게시글 삭제 실패');
                    }
                })
                .catch(err => {
                    console.error('게시글 삭제 오류:', err);
                });
            }
        }
    </script>
</body>
</html>

<section class="container">
    <h2>댓글 관리</h2>
    <table id="comment-list">
        <thead>
            <tr>
                <th>게시글</th>
                <th>댓글 내용</th>
                <th>작성자</th>
                <th>작성일</th>
                <th>관리</th>
            </tr>
        </thead>
        <tbody>
            <!-- 댓글 목록 동적 생성 -->
        </tbody>
    </table>
</section>

<script>
    // 댓글 목록 불러오기
    fetch('/admin/get-comments')
        .then(response => response.json())
        .then(data => {
            const commentList = document.querySelector('#comment-list tbody');
            commentList.innerHTML = '';

            data.comments.forEach(comment => {
                const commentRow = document.createElement('tr');
                commentRow.innerHTML = `
                    <td>${comment.postTitle}</td>
                    <td>${comment.content}</td>
                    <td>${comment.author}</td>
                    <td>${new Date(comment.created_at).toLocaleString()}</td>
                    <td>
                        <button onclick="deleteComment(${comment.id})">삭제</button>
                    </td>
                `;
                commentList.appendChild(commentRow);
            });
        })
        .catch(err => {
            console.error('댓글 목록 불러오기 실패:', err);
        });

    // 댓글 삭제
    function deleteComment(commentId) {
        if (confirm('해당 댓글을 삭제하시겠습니까?')) {
            fetch(`/admin/delete-comment/${commentId}`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    alert('댓글이 삭제되었습니다.');
                    location.reload();
                } else {
                    alert('댓글 삭제 실패');
                }
            })
            .catch(err => {
                console.error('댓글 삭제 오류:', err);
            });
        }
    }
</script>

<td>
    <a href="/admin/user-details.html?id=${user.id}">상세 보기</a>
</td>


<footer>
    <div class="container">
        <p>&copy; 2025 관리자 페이지</p>
    </div>
</footer>


<script>
    // 일일 방문자 수 불러오기
    function loadDailyVisits() {
        fetch('/admin/daily-visits')
            .then(response => response.json())
            .then(data => {
                const visitorTable = document.querySelector('#visitor-table tbody');
                visitorTable.innerHTML = '';

                data.forEach(visit => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${visit.visit_date}</td>
                        <td>${visit.visit_count}</td>
                    `;
                    visitorTable.appendChild(row);
                });
            })
            .catch(err => {
                console.error('방문자 수 조회 실패:', err);
            });
    }

    loadDailyVisits();
    setInterval(loadDailyVisits, 3600000);  // 1시간마다 갱신

</script>
