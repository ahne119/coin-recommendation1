<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>자유 게시판 - 코인 추천 커뮤니티</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <h1>자유 게시판</h1>
            <nav>
                <ul>
                    <li><a href="index.html">홈</a></li>
                    <li><a href="board.html">게시판</a></li>
                    <li><a href="realtime.html">실시간 추천</a></li> <!-- 실시간 추천 메뉴 추가 -->
                    <li><a href="profile.html">프로필</a></li>
                    <li id="login-item"><a href="login.html">로그인</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <main>
        <section class="container">
            <h2>게시글 목록</h2>

            <!-- 글 작성 버튼 (로그인 상태일 때만 표시) -->
            <button id="show-post-form" style="display: none;" class="btn-primary">글 작성</button>

            <!-- 글 작성 폼 (기본적으로 숨김) -->
            <form id="post-form" style="display: none; margin-top: 20px;">
                <h2>글 작성</h2>
                
                <!-- 제목 입력란 (간단한 input 태그 사용) -->
                <div style="margin-bottom: 20px;">
                    <label for="title">제목:</label>
                    <input type="text" id="title" name="title" style="width: 100%; padding: 10px; font-size: 18px;" required>
                </div>

                <!-- Quill 에디터 컨테이너 (본문 작성) -->
                <div id="editor-container" style="height: 300px;"></div>  
                <input type="hidden" id="content" name="content">  

                <button type="submit" class="btn-submit">등록</button>
            </form>

            <!-- 게시글 목록 (리스트 형태) -->
            <table id="board-list">
                <thead>
                    <tr>
                        <th>번호</th>
                        <th>제목</th>
                        <th>작성자</th>
                        <th>작성일</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 게시글 동적 삽입 -->
                </tbody>
            </table>

            <!-- 페이지네이션 영역 -->
            <div id="pagination"></div>
        </section>
    </main>
    
    <footer>
        <div class="container">
            <p>&copy; 2025 코인 추천 커뮤니티</p>
        </div>
    </footer>
    
    <script>
        let currentSearch = '';

        // 게시글 불러오기
        function loadPosts(page = 1) {
            fetch(`/posts?page=${page}`)
                .then(response => response.json())
                .then(data => {
                    const boardList = document.querySelector('#board-list tbody');
                    const pagination = document.getElementById('pagination');
                    boardList.innerHTML = '';

                    data.posts.forEach((post, idx) => {
                        const postRow = document.createElement('tr');
                        postRow.innerHTML = `
                            <td>${(data.currentPage - 1) * 10 + idx + 1}</td>
                            <td><a href="/post.html?id=${post.id}" class="post-link">${post.title}</a></td>
                            <td>${post.author}</td>
                            <td>${new Date(post.created_at).toLocaleDateString()}</td>
                        `;
                        boardList.appendChild(postRow);
                    });

                    // 페이지네이션 업데이트
                    pagination.innerHTML = '';
                    for (let i = 1; i <= data.totalPages; i++) {
                        const pageItem = document.createElement('button');
                        pageItem.innerText = i;
                        pageItem.classList.add('page-btn');
                        if (i === data.currentPage) {
                            pageItem.classList.add('active');
                        }
                        pageItem.addEventListener('click', () => loadPosts(i));
                        pagination.appendChild(pageItem);
                    }
                })
                .catch(err => {
                    console.error('게시글 불러오기 실패:', err);
                });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadPosts();
        });

        // Quill 에디터 초기화 (본문 작성용)
        const quill = new Quill('#editor-container', {
            theme: 'snow',
            placeholder: '본문을 입력하세요...',
            modules: {
                toolbar: [
                    [{ header: [1, 2, false] }],
                    ['bold', 'italic', 'underline'],
                    ['link', 'image', 'blockquote'],
                    [{ list: 'ordered' }, { list: 'bullet' }],
                    ['clean']
                ]
            }
        });

        // 폼 제출 시 제목과 본문 전송
        document.getElementById('post-form').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const content = quill.root.innerHTML;
            const title = document.getElementById('title').value;

            fetch('/create-post', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, content })
            })
            .then(response => {
                if (response.ok) {
                    alert('게시글이 등록되었습니다.');
                    window.location.href = '/board.html';
                }
            })
            .catch(err => {
                console.error('게시글 작성 오류:', err);
                alert('게시글 작성 중 문제가 발생했습니다.');
            });
        });

        // 글 작성 폼 표시
        function showPostForm() {
            document.getElementById('post-form').style.display = 'block';
        }

        // 로그인 상태 확인 및 글 작성 버튼 표시
        fetch('/get-user')
            .then(response => response.json())
            .then(data => {
                const loginItem = document.getElementById('login-item');
                const postButton = document.getElementById('show-post-form');

                if (data.nickname) {
                    loginItem.innerHTML = `<span>${data.nickname}님 | </span><a href="/logout">로그아웃</a>`;
                    postButton.style.display = 'block';
                    postButton.addEventListener('click', showPostForm);
                } else {
                    loginItem.innerHTML = `<a href="login.html">로그인</a>`;
                }
            })
            .catch(err => {
                console.error('로그인 상태 확인 실패:', err);
            });
    </script>
</body>
</html>
